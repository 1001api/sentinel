import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";const projectID=document.getElementById("project-id")?.textContent,id=projectID?JSON.parse(projectID):null,chatContainer=document.getElementById("chat-container"),chatInput=document.getElementById("chat-input"),chatSubmit=document.getElementById("chat-submit");function parseSSEData(e){if(!e.startsWith("data: "))return null;return e.slice(6).replace(/^"/,"").replace(/"$/,"")}function cleanText(e){return e.replace(/\\n/g,"\n").trim()}function scrollToBottom(){const e={top:chatContainer.scrollHeight,behavior:"smooth"};chatContainer.scrollTo(e)}function createMessageBubble(e,t=!1){const n=document.createElement("div");n.className="flex w-full mb-4 "+(t?"justify-end":"justify-start");const a=document.createElement("div");return a.className="max-w-[70%] font-inherit p-3 rounded-lg overflow-x-auto whitespace-pre-wrap "+(t?"bg-blue-500 text-white text-sm rounded-br-none":"bg-gray-200 dark:bg-gray-600 text-sm text-gray-900 dark:text-white rounded-bl-none"),a.textContent=e,n.appendChild(a),n}function addMessage(e,t=!1,n=!1){const a=createMessageBubble(e,t);if(chatContainer.appendChild(a),n){handleStreamingResponse(a.querySelector("div"))}}function handleSubmit(){const e=chatInput.value.trim();""!==e&&(chatInput.disabled=!0,chatSubmit.disabled=!0,addMessage(e,!0),addMessage("Generating response...",!1,!0),chatInput.value="",chatInput.disabled=!1,chatSubmit.disabled=!1,chatInput.focus())}async function handleStreamingResponse(e){try{const t=await fetch(`/api/ai/stream/summary?query=${chatInput.value}&projectId=${id}`,{method:"POST"});if(!t.ok)throw new Error(t.status);const n=t.body.getReader(),a=new TextDecoder;let r="",o="";for(;;){const{value:t,done:s}=await n.read();if(s)break;o+=a.decode(t,{stream:!0});const c=o.split("\n");o=c.pop()||"";for(const t of c){const n=parseSSEData(t);if(null!==n){r+=n;const t=cleanText(r),a=marked.parse(t);e.innerHTML=a,scrollToBottom()}}}}catch(t){if(console.error("Streaming error:",t),"429"===t.message)return e.innerHTML="<strong>[Oopss, you are using DEMO account]</strong><br/>Requests are limited to only 5 requests per minute. Please wait for a while...",void scrollToBottom();e.textContent="Sorry, there was an error processing your request."}}chatSubmit.addEventListener("click",handleSubmit),chatInput.addEventListener("keypress",(e=>{"Enter"===e.key&&handleSubmit()})),addMessage("Hello! How can I help you today?");
